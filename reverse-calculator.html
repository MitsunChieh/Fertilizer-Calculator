<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>營養液反向計算機</title>
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .fertilizer-list {
            margin-top: 20px;
            border: 1px solid #e0e0e0;
            padding: 20px;
            border-radius: 12px;
            background-color: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .fertilizer-list h2 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #eef2f7;
            padding-bottom: 12px;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        .fertilizer-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .fertilizer-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 10px;
            background-color: #f8fafc;
            border: 1px solid #edf2f7;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .fertilizer-list li:hover {
            background-color: #edf2f7;
            transform: translateX(2px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .fertilizer-list .fertilizer-info {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-right: 24px;
            min-width: 0;
            gap: 16px;
        }
        .fertilizer-list .formula {
            font-weight: 500;
            color: #2d3748;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.95em;
        }
        .fertilizer-list .amount {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: flex-end;
        }
        .fertilizer-list .amount-display {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: #edf2f7;
            color: #4a5568;
            font-family: monospace;
            transition: all 0.2s ease;
        }
        .fertilizer-list .amount-display:hover {
            background-color: #e2e8f0;
        }
        .fertilizer-list .amount-input {
            width: 100px;
            padding: 4px 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            text-align: right;
            font-family: monospace;
        }
        .fertilizer-list .edit-controls {
            display: flex;
            gap: 4px;
        }
        .fertilizer-list .edit-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .fertilizer-list .save-btn {
            background-color: #48bb78;
            color: white;
        }
        .fertilizer-list .save-btn:hover {
            background-color: #38a169;
        }
        .fertilizer-list .cancel-btn {
            background-color: #a0aec0;
            color: white;
        }
        .fertilizer-list .cancel-btn:hover {
            background-color: #718096;
        }
        .fertilizer-list .remove-btn {
            background-color: #fc8181;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }
        .fertilizer-list .remove-btn:hover {
            background-color: #f56565;
        }
        .no-fertilizers {
            text-align: center;
            color: #718096;
            font-style: italic;
            padding: 24px;
            background-color: #f7fafc;
            border-radius: 8px;
            border: 1px dashed #cbd5e0;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .result-table th, .result-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        .fertilizer-selector select {
            width: 100%;
            margin: 10px 0;
            max-height: 200px;
        }
        
        #fertilizer-search {
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .test-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        .test-btn:hover {
            background-color: #2980b9;
        }
        
        /* 新增的樣式 */
        .target-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            text-align: right;
            font-family: monospace;
        }
        .target-row td {
            padding: 8px;
            vertical-align: middle;
        }
        /* 添加導航按鈕樣式 */
        .nav-button {
            display: inline-block;
            padding: 8px 16px;
            background-color: #4299e1;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s ease;
            margin-bottom: 20px;
        }

        .nav-button:hover {
            background-color: #3182ce;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .input-mode-switch {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: flex-end;
        }

        .mode-btn {
            padding: 6px 12px;
            border: 1px solid #4299e1;
            background-color: white;
            color: #4299e1;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-btn.active {
            background-color: #4299e1;
            color: white;
        }

        .target-input[disabled] {
            background-color: #f7fafc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>營養液反向計算機</h1>
        
        <!-- 添加返回按鈕 -->
        <a href="index.html" class="nav-button">
            ← 返回成分計算機
        </a>

        <!-- 目標養分輸入區域 -->
        <div class="fertilizer-list">
            <h2>目標養分含量</h2>
            <div class="input-mode-switch">
                <button class="mode-btn active" data-mode="ppm">ppm 模式</button>
                <button class="mode-btn" data-mode="meq">meq/L 模式</button>
            </div>
            <table class="result-table">
                <thead>
                    <tr>
                        <th>元素</th>
                        <th>目標 ppm</th>
                        <th>目標 meq/L</th>
                        <th>目標 mmol/L</th>
                    </tr>
                </thead>
                <tbody id="target-nutrients">
                    <!-- 將由 JavaScript 動態填充 -->
                </tbody>
            </table>
        </div>

        <!-- 可用肥料清單 -->
        <div class="fertilizer-list">
            <h2>可用肥料</h2>
            <input type="text" id="fertilizer-search" placeholder="輸入肥料名稱或分子式搜尋...">
            <select id="fertilizer-select" size="5">
                <option value="">請選擇肥料...</option>
            </select>
            <button onclick="addAvailableFertilizer()" class="test-btn">添加到可用肥料</button>
        </div>

        <!-- 已選擇的可用肥料 -->
        <div class="fertilizer-list">
            <h2>已選擇的可用肥料</h2>
            <ul id="available-fertilizers"></ul>
        </div>

        <!-- 計算結果 -->
        <div class="fertilizer-list">
            <h2>計算結果</h2>
            <button onclick="calculateFertilizers()" class="test-btn">計算肥料用量</button>
            <div id="calculation-results">
                <!-- 計算結果將由 JavaScript 動態填充 -->
            </div>
        </div>
    </div>

    <script>
        // 添加名稱對應表
        const fertilizerAliases = {
            'Fe-EDTA·3H2O': 'C10H12FeN2NaO8·3H2O',
            '螯合鐵': 'C10H12FeN2NaO8·3H2O'
        };

        // 分子量對照表
        const molecularWeights = {
            // 化合物
            'Ca(NO3)2·4H2O': 236.149920,    // 40.078 + 2(14.0067 + 3*15.999) + 4(18.015340)
            'KNO3': 101.102530,             // 39.0983 + 14.0067 + 3*15.999
            'MgSO4·7H2O': 246.474780,       // 24.305 + 32.065 + 4*15.999 + 7(18.015340)
            'NH4H2PO4': 115.025738,         // 14.0067 + 4*1.007940 + 30.973762 + 4*15.999
            'Ca(H2PO4)2·H2O': 252.082802,   // 40.078 + 2(2*1.007940 + 30.973762 + 4*15.999) + 18.015340
            'C10H12FeN2NaO8·3H2O': 412.147420,  // Fe-EDTA·3H2O: 10*12.0107 + 12*1.007940 + 55.845 + 2*14.0067 + 22.989770 + 8*15.999 + 3(18.015340)
            'H3BO3': 61.833220,             // 3*1.007940 + 10.811 + 3*15.999
            'MnCl2·4H2O': 197.905360,       // 54.938045 + 2*35.453 + 4(18.015340)
            'ZnSO4·7H2O': 287.539780,       // 65.38 + 32.065 + 4*15.999 + 7(18.015340)
            'CuSO4·5H2O': 249.685700,       // 63.546 + 32.065 + 4*15.999 + 5(18.015340)
            'Na2MoO4·2H2O': 241.950680,     // 2*22.989770 + 95.96 + 4*15.999 + 2(18.015340)
            'KH2PO4': 136.085838,           // 39.0983 + 2*1.007940 + 30.973762 + 4*15.999
            'Ca(NO3)2': 164.088400,         // 40.078 + 2(14.0067 + 3*15.999)
            'MgSO4': 120.366000,            // 24.305 + 32.065 + 4*15.999
            '(NH4)6Mo7O24·4H2O': 1235.86,    // 6(14.0067 + 4*1.007940) + 7*95.96 + 24*15.999 + 4(2*1.007940 + 15.999)
            '(NH4)2MoO4': 196.0354,  // (2 * (14.0067 + 4 * 1.00794)) + 95.96 + (4 * 15.999)

            // 元素
            'N': 14.006700,
            'P': 30.973762,
            'K': 39.098300,
            'Ca': 40.078000,
            'Mg': 24.305000,
            'S': 32.065000,
            'Fe': 55.845000,
            'Mn': 54.938045,
            'Zn': 65.380000,
            'Cu': 63.546000,
            'B': 10.811000,
            'Mo': 95.960000,
            'Cl': 35.453000,
            
            // 常用計算值
            'H': 1.007940,
            'O': 15.999000,
            'Na': 22.989770,
            'C': 12.010700,
            'H2O': 18.015340    // 2*1.007940 + 15.999
        };

        // 肥料成分對照表（以重量比例表示）
        const fertilizerComposition = {
            // 大量元素肥料
            'Ca(NO3)2·4H2O': {
                'Ca': 0.169715,  // 40.078 / 236.149920 = 16.97% Ca
                'N': 0.118721    // (2 * 14.0067) / 236.149920 = 11.87% N
            },
            'KNO3': {
                'K': 0.386716,   // 39.0983 / 101.102530 = 38.67% K
                'N': 0.138486    // 14.0067 / 101.102530 = 13.85% N
            },
            'MgSO4·7H2O': {
                'Mg': 0.098611,  // 24.305 / 246.474780 = 9.86% Mg
                'S': 0.130095    // 32.065 / 246.474780 = 13.01% S
            },
            'NH4H2PO4': {
                'N': 0.121773,   // 14.0067 / 115.025738 = 12.18% N
                'P': 0.269278,   // 30.973762 / 115.025738 = 26.93% P
                'H': 0.035023    // (4 * 1.007940) / 115.025738 = 3.50% H
            },
            'Ca(H2PO4)2·H2O': {
                'Ca': 0.158987,  // 40.078 / 252.082802 = 15.90% Ca
                'P': 0.245848,   // (2 * 30.973762) / 252.082802 = 24.58% P
                'H': 0.008000    // (4 * 1.007940) / 252.082802 = 0.80% H
            },
            'KH2PO4': {
                'K': 0.287305,   // 39.0983 / 136.085838 = 28.73% K
                'P': 0.227605,   // 30.973762 / 136.085838 = 22.76% P
                'H': 0.014819    // (2 * 1.007940) / 136.085838 = 1.48% H
            },
            'Ca(NO3)2': {
                'Ca': 0.244497,  // 40.078 / 164.088400 = 24.45% Ca
                'N': 0.170744    // (2 * 14.0067) / 164.088400 = 17.07% N
            },
            'MgSO4': {
                'Mg': 0.201927,  // 24.305 / 120.366000 = 20.19% Mg
                'S': 0.266393    // 32.065 / 120.366000 = 26.64% S
            },

            // 微量元素肥料
            'C10H12FeN2NaO8·3H2O': {
                'Fe': 0.135498   // 55.845 / 412.147420 = 13.55% Fe
            },
            'H3BO3': {
                'B': 0.174842    // 10.811 / 61.833220 = 17.48% B
            },
            'MnCl2·4H2O': {
                'Mn': 0.277595,  // 54.938045 / 197.905360 = 27.76% Mn
                'Cl': 0.358521   // (2 * 35.453) / 197.905360 = 35.85% Cl
            },
            'ZnSO4·7H2O': {
                'Zn': 0.227379,  // 65.38 / 287.539780 = 22.74% Zn
                'S': 0.111515    // 32.065 / 287.539780 = 11.15% S
            },
            'CuSO4·5H2O': {
                'Cu': 0.254504,  // 63.546 / 249.685700 = 25.45% Cu
                'S': 0.128421    // 32.065 / 249.685700 = 12.84% S
            },
            'Na2MoO4·2H2O': {
                'Mo': 0.396610   // 95.96 / 241.950680 = 39.66% Mo
            },
            '(NH4)6Mo7O24·4H2O': {
                'N': 0.068033,   // (6 * 14.0067) / 1235.86 = 6.80% N
                'Mo': 0.543754   // (7 * 95.96) / 1235.86 = 54.38% Mo
            },
            '(NH4)2MoO4': {
                'N': 0.142935,   // (2 * 14.0067) / 196.0354 = 14.29% N
                'Mo': 0.489497   // (1 * 95.96) / 196.0354 = 48.95% Mo
            }
        };

        // 離子價數對照表（用於 meq 計算）
        const ionicCharges = {
            'N': -1,    // NO3- 形式
            'P': -1,    // H2PO4- 形式
            'K': +1,    // K+ 形式
            'Ca': +2,   // Ca2+ 形式
            'Mg': +2,   // Mg2+ 形式
            'S': -2,    // SO4-2 形式
            'Fe': +2,   // Fe2+ 形式
            'Mn': +2,   // Mn2+ 形式
            'Zn': +2,   // Zn2+ 形式
            'Cu': +2,   // Cu2+ 形式
            'B': +3,    // B3+ 形式
            'Mo': -2,   // MoO4-2 形式
            'Cl': -1    // Cl- 形式
        };

        const selectedFertilizers = [];

        // 定義肥料清單
        const fertilizerList = [
            { value: 'Ca(NO3)2·4H2O', label: '硝酸鈣（四水） Ca(NO3)2·4H2O' },
            { value: 'NH4H2PO4', label: '磷酸一銨 NH4H2PO4' },
            { value: 'MgSO4·7H2O', label: '硫酸鎂（七水） MgSO4·7H2O' },
            { value: 'Ca(H2PO4)2·H2O', label: '磷酸一鈣（一水） Ca(H2PO4)2·H2O' },
            { value: 'Ca(NO3)2', label: '硝酸鈣 Ca(NO3)2' },
            { value: 'KNO3', label: '硝酸鉀 KNO3' },
            { value: 'MgSO4', label: '硫酸鎂 MgSO4' },
            { value: 'KH2PO4', label: '磷酸二氫鉀 KH2PO4' },
            { value: 'Fe-EDTA·3H2O', label: '螯合鐵（Fe-EDTA·3H2O）' },
            { value: 'H3BO3', label: '硼酸 H3BO3' },
            { value: 'MnCl2·4H2O', label: '氯化錳（四水） MnCl2·4H2O' },
            { value: 'ZnSO4·7H2O', label: '硫酸鋅（七水） ZnSO4·7H2O' },
            { value: 'CuSO4·5H2O', label: '硫酸銅（五水） CuSO4·5H2O' },
            { value: 'Na2MoO4·2H2O', label: '鉬酸鈉（二水） Na2MoO4·2H2O' },
            { value: '(NH4)6Mo7O24·4H2O', label: '仲鉬酸銨（四水） (NH4)6Mo7O24·4H2O' },
            { value: '(NH4)2MoO4', label: '鉬酸銨 (NH4)2MoO4' }
        ];
        
        // 添加反向計算的特定函數
        // ... 

        // 全局變量
        let availableFertilizers = [];
        let targetNutrients = {
            'N': { ppm: 0, meq: 0, mmol: 0 },
            'P': { ppm: 0, meq: 0, mmol: 0 },
            'K': { ppm: 0, meq: 0, mmol: 0 },
            'Ca': { ppm: 0, meq: 0, mmol: 0 },
            'Mg': { ppm: 0, meq: 0, mmol: 0 },
            'S': { ppm: 0, meq: 0, mmol: 0 },
            'Fe': { ppm: 0, meq: 0, mmol: 0 },
            'Mn': { ppm: 0, meq: 0, mmol: 0 },
            'Zn': { ppm: 0, meq: 0, mmol: 0 },
            'Cu': { ppm: 0, meq: 0, mmol: 0 },
            'B': { ppm: 0, meq: 0, mmol: 0 },
            'Mo': { ppm: 0, meq: 0, mmol: 0 },
            'Cl': { ppm: 0, meq: 0, mmol: 0 }
        };

        let currentInputMode = 'ppm';  // 預設使用 ppm 模式

        // 初始化頁面
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // 初始化頁面
        function initializePage() {
            // 初始化肥料選擇器
            initializeFertilizerSelect();
            
            // 初始化目標養分輸入表格
            initializeTargetNutrients();
            
            // 初始化搜尋功能
            const searchInput = document.getElementById('fertilizer-search');
            searchInput.addEventListener('input', function(e) {
                searchFertilizers(e.target.value);
            });
            
            // 初始化模式切換按鈕
            initializeInputModeSwitch();
        }

        // 初始化肥料選擇器
        function initializeFertilizerSelect() {
            const select = document.getElementById('fertilizer-select');
            select.innerHTML = '<option value="">請選擇肥料...</option>';
            
            fertilizerList.forEach(fertilizer => {
                const option = document.createElement('option');
                option.value = fertilizer.value;
                option.textContent = fertilizer.label;
                select.appendChild(option);
            });
        }

        // 初始化目標養分輸入表格
        function initializeTargetNutrients() {
            const tbody = document.getElementById('target-nutrients');
            tbody.innerHTML = '';
            
            Object.entries(targetNutrients).forEach(([element, values]) => {
                const tr = document.createElement('tr');
                tr.className = 'target-row';
                
                // 在元素符號後添加離子電荷標示
                const chargeSymbol = ionicCharges[element] > 0 ? 
                    `<sup>${ionicCharges[element]}+</sup>` : 
                    `<sup>${Math.abs(ionicCharges[element])}-</sup>`;
                
                tr.innerHTML = `
                    <td>${element}${chargeSymbol}</td>
                    <td><input type="number" class="target-input" data-element="${element}" data-type="ppm" value="0" step="0.0001"></td>
                    <td><input type="number" class="target-input" data-element="${element}" data-type="meq" value="0" step="0.000001"></td>
                    <td><input type="number" class="target-input" data-element="${element}" data-type="mmol" value="0" step="0.000001"></td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // 添加輸入事件監聽器
            document.querySelectorAll('.target-input').forEach(input => {
                input.addEventListener('input', handleTargetInput);
            });
        }

        // 處理目標養分輸入
        function handleTargetInput(event) {
            const input = event.target;
            const element = input.dataset.element;
            const type = input.dataset.type;
            const value = parseFloat(input.value) || 0;
            
            // 更新目標值
            targetNutrients[element][type] = roundNumber(value, type === 'ppm' ? 4 : 6);
            
            // 自動計算其他值
            updateOtherValues(element, type, value);
        }

        // 更新其他相關值
        function updateOtherValues(element, changedType, value) {
            const inputs = document.querySelectorAll(`.target-input[data-element="${element}"]`);
            const molecularWeight = molecularWeights[element];
            const charge = Math.abs(ionicCharges[element]);
            
            inputs.forEach(input => {
                if (input.dataset.type !== changedType) {
                    let newValue = 0;
                    switch (changedType) {
                        case 'ppm':
                            if (input.dataset.type === 'mmol') {
                                newValue = value / molecularWeight;
                            } else if (input.dataset.type === 'meq') {
                                newValue = (value / molecularWeight) * charge;
                            }
                            break;
                        case 'meq':
                            if (input.dataset.type === 'mmol') {
                                newValue = value / charge;
                            } else if (input.dataset.type === 'ppm') {
                                newValue = (value / charge) * molecularWeight;
                            }
                            break;
                    }
                    input.value = formatNumber(newValue, input.dataset.type === 'ppm' ? 4 : 6);
                    targetNutrients[element][input.dataset.type] = roundNumber(newValue, input.dataset.type === 'ppm' ? 4 : 6);
                }
            });
        }

        // 添加新的初始化函數
        function initializeInputModeSwitch() {
            const buttons = document.querySelectorAll('.mode-btn');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    const mode = this.dataset.mode;
                    setInputMode(mode);
                    
                    // 更新按鈕狀態
                    buttons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // 初始設置
            setInputMode(currentInputMode);
        }

        // 設置輸入模式
        function setInputMode(mode) {
            currentInputMode = mode;
            const inputs = document.querySelectorAll('.target-input');
            
            inputs.forEach(input => {
                if (input.dataset.type === 'mmol') {
                    // mmol 始終禁用，但保持顯示
                    input.disabled = true;
                    input.style.backgroundColor = '#f7fafc';
                } else if (input.dataset.type === mode) {
                    // 啟用當前模式的輸入
                    input.disabled = false;
                    input.style.backgroundColor = 'white';
                } else {
                    // 禁用其他模式的輸入
                    input.disabled = true;
                    input.style.backgroundColor = '#f7fafc';
                }
            });
        }

        // 精度處理工具函數
        function roundNumber(value, precision = 3) {
            if (typeof value !== 'number' || isNaN(value)) return 0;
            const multiplier = Math.pow(10, precision);
            // 使用四捨六入五成雙規則
            const roundedValue = Math.round(value * multiplier) / multiplier;
            return roundedValue;
        }

        // 格式化顯示數值
        function formatNumber(value, precision = 3) {
            const roundedValue = roundNumber(value, precision);
            // 確保顯示指定的小數位數
            return roundedValue.toFixed(precision);
        }
    </script>
</body>
</html>
